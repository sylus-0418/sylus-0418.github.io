<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#6B7280',
                        neutral: '#F3F4F6',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                        weiyaruhei: ['"Microsoft YaHei"', 'sans-serif'],
                        song: ['"SimSun"', 'serif'],
                        kai: ['"KaiTi"', 'serif'],
                        hei: ['"SimHei"', 'sans-serif'],
                        fang: ['"FangSong"', 'serif'],
                        times: ['"Times New Roman"', 'serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .folder-tree-item {
                @apply py-1 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors duration-150;
            }
            .folder-tree-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .editor-toolbar-btn {
                @apply p-2 rounded transition-all duration-150 flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700;
            }
            .editor-toolbar-btn.active {
                @apply ring-2 ring-primary/50 bg-primary/10 text-primary;
            }
            .color-btn {
                @apply w-8 h-8 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-gray-200 dark:border-gray-600 cursor-pointer;
            }
            .color-indicator {
                @apply w-4 h-4 rounded-full inline-block mr-1;
            }
            .file-attachment {
                @apply flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg my-2 border border-gray-200 dark:border-gray-600;
            }
            .file-icon {
                @apply text-gray-500 dark:text-gray-400 mr-3;
            }
            .file-info {
                @apply flex-1;
            }
            .file-name {
                @apply font-medium;
            }
            .file-size {
                @apply text-sm text-gray-500 dark:text-gray-400;
            }
            .resizer {
                @apply w-1 bg-gray-300 dark:bg-gray-600 cursor-col-resize hover:bg-primary transition-colors duration-200 relative z-10;
            }
            .resizer::before {
                content: '';
                @apply absolute top-0 left-1/2 -translate-x-1/2 h-full w-3 cursor-col-resize;
            }
            .save-indicator {
                @apply text-xs ml-2 px-1.5 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 opacity-0 transition-opacity duration-300;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200 h-screen flex overflow-hidden transition-colors duration-300">
    <!-- 主容器 -->
    <div class="flex flex-col md:flex-row w-full h-full overflow-hidden">
        <!-- 左侧导航区 -->
        <div id="leftPanel" class="w-full md:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col h-full overflow-hidden transition-colors duration-300">
            <!-- 左侧标签切换 -->
            <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button id="folderTab" class="flex-1 py-3 px-4 text-center font-medium text-primary border-b-2 border-primary">
                    <i class="fa fa-folder mr-2"></i>文件夹
                </button>
                <button id="linkTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors">
                    <i class="fa fa-link mr-2"></i>链接
                </button>
            </div>
            
            <!-- 文件夹内容区 -->
            <div id="folderContent" class="flex-1 overflow-y-auto scrollbar-hide p-3">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">文件夹列表</h3>
                    <button id="addRootFolder" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary hover:bg-primary/10 rounded transition-colors">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                
                <!-- 文件夹树结构 -->
                <div id="folderTree" class="space-y-1 text-sm">
                    <!-- 初始文件夹示例 -->
                    <div class="folder-item" id="folder-1">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder-open text-yellow-500 mr-2"></i>
                                <span class="folder-name">项目文档</span>
                            </div>
                            <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pl-6 mt-1 space-y-1">
                            <div class="folder-tree-item flex items-center justify-between document-item" data-document="项目计划.md">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">项目计划.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="folder-item" id="folder-2">
                                <div class="folder-tree-item flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                        <span class="folder-name">需求分析</span>
                                    </div>
                                    <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                        <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-plus-circle"></i>
                                        </button>
                                        <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-pencil"></i>
                                        </button>
                                        <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="pl-6 mt-1 space-y-1 hidden">
                                    <div class="folder-tree-item flex items-center justify-between document-item" data-document="用户需求.md">
                                        <div class="flex items-center">
                                            <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                            <span class="document-name">用户需求.md</span>
                                        </div>
                                        <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                            <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                                <i class="fa fa-pencil"></i>
                                            </button>
                                            <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                                <i class="fa fa-arrows"></i>
                                            </button>
                                            <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="folder-item" id="folder-3">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                <span class="folder-name">技术文档</span>
                            </div>
                            <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <!-- 技术文档的子内容 -->
                        <div class="pl-6 mt-1 space-y-1 hidden">
                            <div class="folder-tree-item flex items-center justify-between document-item" data-document="架构设计.md">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">架构设计.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="folder-tree-item flex items-center justify-between document-item" data-document="API文档.md">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">API文档.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 添加文档按钮 -->
                <div class="mt-4">
                    <button id="addDocument" class="w-full py-2 px-3 border border-dashed border-gray-300 dark:border-gray-600 rounded text-gray-500 dark:text-gray-400 hover:border-primary hover:text-primary transition-colors flex items-center justify-center">
                        <i class="fa fa-file-text-o mr-2"></i>添加新文档
                    </button>
                </div>
            </div>
            
            <!-- 链接内容区 (默认隐藏) -->
            <div id="linkContent" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">链接列表</h3>
                    <button id="addLink" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary hover:bg-primary/10 rounded transition-colors">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                
                <div id="linkTree" class="space-y-1 text-sm">
                    <!-- 链接可以有层级结构 -->
                    <div class="link-item" id="link-folder-1">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                <span class="link-folder-name">外部资源</span>
                            </div>
                            <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pl-6 mt-1 space-y-1 hidden">
                            <div class="folder-tree-item flex items-center justify-between cursor-pointer">
                                <div class="flex items-center">
                                    <i class="fa fa-external-link text-blue-500 mr-2"></i>
                                    <span class="link-name">官方文档</span>
                                </div>
                                <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="insert-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-clipboard"></i>
                                    </button>
                                    <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 可拖拽分隔线 -->
        <div id="resizer" class="resizer md:block hidden"></div>
        
        <!-- 右侧编辑/预览区 -->
        <div id="rightPanel" class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900 h-full overflow-hidden transition-colors duration-300">
            <!-- 顶部控制栏 -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 flex justify-between items-center">
                <div class="flex items-center">
                    <button id="toggleEditorToolbar" class="editor-toolbar-btn mr-1">
                        <i class="fa fa-wrench"></i>
                    </button>
                    <span id="currentFileName" class="text-sm text-gray-500 dark:text-gray-400">项目计划.md</span>
                    <span id="saveIndicator" class="save-indicator">已保存</span>
                </div>
                <div class="flex items-center">
                    <button id="themeToggle" class="editor-toolbar-btn mr-1">
                        <i class="fa fa-moon-o dark:hidden"></i>
                        <i class="fa fa-sun-o hidden dark:inline-block"></i>
                    </button>
                    <button id="saveButton" class="editor-toolbar-btn">
                        <i class="fa fa-save"></i>
                    </button>
                </div>
            </div>
            
            <!-- 编辑器工具栏 -->
            <div id="editorToolbar" class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 transition-all duration-300">
                <div class="flex flex-wrap gap-1">
                    <!-- 字体选择 -->
                    <select id="fontFamily" class="editor-toolbar-btn border border-gray-200 dark:border-gray-600 rounded px-2 h-9 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        <option value="Inter, sans-serif">Inter</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
                        <option value="SimSun, serif">宋体</option>
                    </select>
                    
                    <!-- 字号选择 -->
                    <select id="fontSize" class="editor-toolbar-btn border border-gray-200 dark:border-gray-600 rounded px-2 h-9 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        <option value="12px">极小</option>
                        <option value="14px">小</option>
                        <option value="16px" selected>中</option>
                        <option value="18px">大</option>
                        <option value="24px">较大</option>
                    </select>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本格式 -->
                    <button class="editor-toolbar-btn" title="粗体" data-command="bold">
                        <i class="fa fa-bold"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="斜体" data-command="italic">
                        <i class="fa fa-italic"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="下划线" data-command="underline">
                        <i class="fa fa-underline"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本对齐 -->
                    <button class="editor-toolbar-btn" title="左对齐" data-command="justifyLeft">
                        <i class="fa fa-align-left"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="居中对齐" data-command="justifyCenter">
                        <i class="fa fa-align-center"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="右对齐" data-command="justifyRight">
                        <i class="fa fa-align-right"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 列表 -->
                    <button class="editor-toolbar-btn" title="无序列表" data-command="insertUnorderedList">
                        <i class="fa fa-list-ul"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="有序列表" data-command="insertOrderedList">
                        <i class="fa fa-list-ol"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="减少缩进" data-command="outdent">
                        <i class="fa fa-outdent"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="增加缩进" data-command="indent">
                        <i class="fa fa-indent"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本颜色 -->
                    <div class="relative" id="foreColorContainer">
                        <button id="foreColor" class="editor-toolbar-btn" title="文本颜色">
                            <span class="color-indicator bg-black dark:bg-white"></span>
                            <i class="fa fa-font"></i>
                        </button>
                        <div id="foreColorPalette" class="hidden absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 p-2 rounded shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="grid grid-cols-8 gap-1">
                                <!-- 颜色选项会通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 背景颜色 -->
                    <div class="relative" id="hiliteColorContainer">
                        <button id="hiliteColor" class="editor-toolbar-btn" title="背景颜色">
                            <span class="color-indicator bg-yellow-200 dark:bg-yellow-800"></span>
                            <i class="fa fa-highlighter"></i>
                        </button>
                        <div id="hiliteColorPalette" class="hidden absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 p-2 rounded shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="grid grid-cols-8 gap-1">
                                <!-- 颜色选项会通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 插入功能 -->
                    <button class="editor-toolbar-btn" title="插入链接" data-command="createLink">
                        <i class="fa fa-link"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="插入图片" data-command="insertImage">
                        <i class="fa fa-image"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="插入表格">
                        <i class="fa fa-table"></i>
                    </button>
                </div>
            </div>
            
            <!-- 编辑器内容区 -->
            <div class="flex-1 flex overflow-hidden">
                <div id="editorContainer" class="flex-1 overflow-y-auto p-6 bg-white dark:bg-gray-800 m-4 rounded-lg shadow-sm transition-colors duration-300">
                    <div id="editor" class="min-h-full" contenteditable="true">
                        <h1 class="text-2xl font-bold mb-4">项目计划文档</h1>
                        <p class="mb-4">本文档详细描述了项目的整体计划和时间安排，包括以下几个部分：</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">1. 项目背景</h2>
                        <p class="mb-4">该项目旨在开发一个高效的知识库管理系统，帮助团队更好地管理和共享文档资源。</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">2. 项目目标</h2>
                        <ul class="list-disc pl-6 mb-4">
                            <li>建立结构化的文档管理系统</li>
                            <li>支持Markdown格式编辑与预览</li>
                            <li>实现文档的快速检索功能</li>
                            <li>支持多人协作编辑</li>
                        </ul>
                    </div>
                    
                    <!-- 附件上传区域 -->
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="addAttachment" class="editor-toolbar-btn mb-3">
                            <i class="fa fa-paperclip mr-2"></i>添加附件
                        </button>
                        <input type="file" id="attachmentInput" class="hidden" multiple>
                        <div id="attachmentsContainer" class="space-y-2">
                            <!-- 附件会在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let folderIdCounter = 4;
        let documentIdCounter = 1;
        let linkIdCounter = 1;
        let attachmentIdCounter = 1;
        let currentDocument = '项目计划.md'; // 当前打开的文档
        
        // 1. 主题切换功能
        const themeToggle = document.getElementById('themeToggle');
        
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });
        
        // 2. 工具栏切换
        const toggleEditorToolbar = document.getElementById('toggleEditorToolbar');
        const editorToolbar = document.getElementById('editorToolbar');
        
        toggleEditorToolbar.addEventListener('click', () => {
            editorToolbar.classList.toggle('hidden');
        });
        
        // 3. 左侧标签切换
        const folderTab = document.getElementById('folderTab');
        const linkTab = document.getElementById('linkTab');
        const folderContent = document.getElementById('folderContent');
        const linkContent = document.getElementById('linkContent');
        
        folderTab.addEventListener('click', () => {
            folderTab.classList.add('text-primary', 'border-b-2', 'border-primary');
            folderTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            linkTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
            linkTab.classList.add('text-gray-500', 'dark:text-gray-400');
            folderContent.classList.remove('hidden');
            linkContent.classList.add('hidden');
        });
        
        linkTab.addEventListener('click', () => {
            linkTab.classList.add('text-primary', 'border-b-2', 'border-primary');
            linkTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            folderTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
            folderTab.classList.add('text-gray-500', 'dark:text-gray-400');
            linkContent.classList.remove('hidden');
            folderContent.classList.add('hidden');
        });
        
        // 4. 文件夹展开/折叠功能
        function setupFolderToggle() {
            // 文件夹展开/折叠
            document.querySelectorAll('.folder-item').forEach(folder => {
                const folderHeader = folder.querySelector('.folder-tree-item');
                const subItems = folder.querySelector('div.pl-6');
                
                // 确保每个文件夹都有点击事件
                folderHeader.addEventListener('click', (e) => {
                    if (!e.target.closest('.folder-actions')) {
                        subItems.classList.toggle('hidden');
                        const folderIcon = folderHeader.querySelector('.fa-folder, .fa-folder-open');
                        if (folderIcon) {
                            folderIcon.classList.toggle('fa-folder');
                            folderIcon.classList.toggle('fa-folder-open');
                        }
                    }
                });
                
                bindFolderActionButtons(folder);
            });
            
            // 链接文件夹展开/折叠
            document.querySelectorAll('.link-item').forEach(linkFolder => {
                const folderHeader = linkFolder.querySelector('.folder-tree-item');
                const subItems = linkFolder.querySelector('div.pl-6');
                
                folderHeader.addEventListener('click', (e) => {
                    if (!e.target.closest('.link-actions')) {
                        subItems.classList.toggle('hidden');
                        const folderIcon = folderHeader.querySelector('.fa-folder, .fa-folder-open');
                        if (folderIcon) {
                            folderIcon.classList.toggle('fa-folder');
                            folderIcon.classList.toggle('fa-folder-open');
                        }
                    }
                });
                
                bindLinkActionButtons(linkFolder);
            });
            
            // 文档点击事件 - 加载文档内容
            document.querySelectorAll('.document-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.document-actions')) {
                        const docName = item.dataset.document;
                        loadDocument(docName);
                        
                        // 更新活跃状态
                        document.querySelectorAll('.folder-tree-item').forEach(el => {
                            el.classList.remove('active');
                        });
                        item.classList.add('active');
                    }
                });
            });
            
            // 绑定文档操作按钮事件
            bindDocumentActionButtons();
        }
        
        // 绑定文档操作按钮
        function bindDocumentActionButtons() {
            // 重命名文档
            document.querySelectorAll('.rename-document').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const docItem = btn.closest('.document-item');
                    const docNameElement = docItem.querySelector('.document-name');
                    const currentName = docNameElement.textContent;
                    const currentDocKey = docItem.dataset.document;
                    
                    const newName = prompt('请输入新文档名称:', currentName);
                    if (newName && newName !== currentName) {
                        // 更新显示名称
                        docNameElement.textContent = newName;
                        // 更新数据属性
                        docItem.dataset.document = newName;
                        
                        // 如果是当前打开的文档，更新当前文档名
                        if (currentDocKey === currentDocument) {
                            currentDocument = newName;
                            document.getElementById('currentFileName').textContent = newName;
                        }
                        
                        // 更新localStorage中的文档名
                        const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
                        if (documents[currentDocKey]) {
                            documents[newName] = documents[currentDocKey];
                            delete documents[currentDocKey];
                            localStorage.setItem('kbm_documents', JSON.stringify(documents));
                        }
                        
                        // 更新附件关联
                        const allAttachments = JSON.parse(localStorage.getItem('kbm_attachments') || '{}');
                        if (allAttachments[currentDocKey]) {
                            allAttachments[newName] = allAttachments[currentDocKey];
                            delete allAttachments[currentDocKey];
                            localStorage.setItem('kbm_attachments', JSON.stringify(allAttachments));
                        }
                    }
                });
            });
            
            // 移动文档
            document.querySelectorAll('.move-document').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const docItem = btn.closest('.document-item');
                    const docName = docItem.dataset.document;
                    
                    // 获取所有文件夹
                    const folders = Array.from(document.querySelectorAll('.folder-item'));
                    const folderNames = folders.map(folder => folder.querySelector('.folder-name').textContent);
                    
                    if (folderNames.length > 0) {
                        const targetFolderName = prompt(`请选择目标文件夹:\n${folderNames.join('\n')}`, folderNames[0]);
                        
                        if (targetFolderName) {
                            const targetFolder = folders.find(folder => 
                                folder.querySelector('.folder-name').textContent === targetFolderName
                            );
                            
                            if (targetFolder) {
                                // 获取目标文件夹的子内容容器
                                let targetContainer = targetFolder.querySelector('div.pl-6');
                                
                                // 如果不存在则创建
                                if (!targetContainer) {
                                    targetContainer = document.createElement('div');
                                    targetContainer.className = 'pl-6 mt-1 space-y-1';
                                    targetFolder.appendChild(targetContainer);
                                }
                                
                                // 显示目标文件夹
                                targetContainer.classList.remove('hidden');
                                
                                // 更新文件夹图标为打开状态
                                const folderIcon = targetFolder.querySelector('.fa-folder');
                                if (folderIcon) {
                                    folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                                }
                                
                                // 移动文档项
                                docItem.remove();
                                targetContainer.appendChild(docItem);
                            } else {
                                alert('未找到指定的文件夹');
                            }
                        }
                    } else {
                        alert('没有可用的文件夹');
                    }
                });
            });
            
            // 删除文档
            document.querySelectorAll('.delete-document').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const docItem = btn.closest('.document-item');
                    const docName = docItem.dataset.document;
                    
                    if (confirm(`确定要删除文档 "${docName}" 吗?`)) {
                        // 如果删除的是当前打开的文档，需要处理
                        if (docName === currentDocument) {
                            // 尝试找到第一个其他文档
                            const firstDoc = document.querySelector('.document-item:not([data-document="' + docName + '"])');
                            if (firstDoc) {
                                loadDocument(firstDoc.dataset.document);
                                firstDoc.classList.add('active');
                            } else {
                                // 如果没有其他文档，清空编辑器
                                currentDocument = null;
                                document.getElementById('currentFileName').textContent = '';
                                document.getElementById('editor').innerHTML = '';
                                document.getElementById('attachmentsContainer').innerHTML = '';
                            }
                        }
                        
                        // 从localStorage中删除
                        const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
                        if (documents[docName]) {
                            delete documents[docName];
                            localStorage.setItem('kbm_documents', JSON.stringify(documents));
                        }
                        
                        // 删除附件
                        const allAttachments = JSON.parse(localStorage.getItem('kbm_attachments') || '{}');
                        if (allAttachments[docName]) {
                            delete allAttachments[docName];
                            localStorage.setItem('kbm_attachments', JSON.stringify(allAttachments));
                        }
                        
                        // 从DOM中删除
                        docItem.remove();
                    }
                });
            });
        }
        
        // 5. 链接分区功能实现
        document.getElementById('addLink').addEventListener('click', () => {
            const linkName = prompt('请输入链接名称:', `新链接${linkIdCounter}`);
            if (linkName) {
                const linkUrl = prompt('请输入链接地址:');
                if (linkUrl) {
                    addNewLink(linkName, linkUrl, document.getElementById('linkTree'));
                }
            }
        });
        
        function addNewLink(linkName, linkUrl, parentContainer) {
            const linkItem = document.createElement('div');
            linkItem.className = 'folder-tree-item flex items-center justify-between cursor-pointer';
            linkItem.dataset.url = linkUrl;
            
            linkItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fa fa-external-link text-blue-500 mr-2"></i>
                    <span class="link-name">${linkName}</span>
                </div>
                <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                    <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                        <i class="fa fa-pencil"></i>
                    </button>
                    <button class="insert-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                        <i class="fa fa-clipboard"></i>
                    </button>
                    <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
            
            parentContainer.appendChild(linkItem);
            bindLinkItemActionButtons(linkItem);
        }
        
        function bindLinkActionButtons(linkFolder) {
            // 添加子链接
            const addChildBtn = linkFolder.querySelector('.add-child-link');
            if (addChildBtn) {
                addChildBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const linkName = prompt('请输入链接名称:');
                    if (linkName) {
                        const linkUrl = prompt('请输入链接地址:');
                        if (linkUrl) {
                            const subLinkContainer = linkFolder.querySelector('div.pl-6');
                            addNewLink(linkName, linkUrl, subLinkContainer);
                            
                            // 显示子链接容器
                            subLinkContainer.classList.remove('hidden');
                            const folderIcon = linkFolder.querySelector('.fa-folder');
                            if (folderIcon) {
                                folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                            }
                        }
                    }
                });
            }
            
            // 重命名链接文件夹
            const renameBtn = linkFolder.querySelector('.rename-link');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentName = linkFolder.querySelector('.link-folder-name')?.textContent || 
                                      linkFolder.querySelector('.link-name')?.textContent;
                    if (currentName) {
                        const newName = prompt('请输入新名称:', currentName);
                        if (newName && newName !== currentName) {
                            const nameElement = linkFolder.querySelector('.link-folder-name') || 
                                              linkFolder.querySelector('.link-name');
                            if (nameElement) {
                                nameElement.textContent = newName;
                            }
                        }
                    }
                });
            }
            
            // 删除链接
            const deleteBtn = linkFolder.querySelector('.delete-link');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个链接吗?')) {
                        linkFolder.remove();
                    }
                });
            }
        }
        
        function bindLinkItemActionButtons(linkItem) {
            // 重命名链接
            const renameBtn = linkItem.querySelector('.rename-link');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentName = linkItem.querySelector('.link-name').textContent;
                    const newName = prompt('请输入新名称:', currentName);
                    if (newName && newName !== currentName) {
                        linkItem.querySelector('.link-name').textContent = newName;
                    }
                });
            }
            
            // 插入链接到编辑器
            const insertBtn = linkItem.querySelector('.insert-link');
            if (insertBtn) {
                insertBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const linkUrl = linkItem.dataset.url;
                    const linkName = linkItem.querySelector('.link-name').textContent;
                    
                    // 在编辑器中插入链接
                    document.execCommand('insertHTML', false, `<a href="${linkUrl}" target="_blank">${linkName}</a>`);
                    // 触发保存
                    saveDocument();
                });
            }
            
            // 删除链接
            const deleteBtn = linkItem.querySelector('.delete-link');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个链接吗?')) {
                        linkItem.remove();
                    }
                });
            }
            
            // 点击链接打开
            linkItem.addEventListener('click', (e) => {
                if (!e.target.closest('.link-actions')) {
                    const linkUrl = linkItem.dataset.url;
                    if (linkUrl) {
                        window.open(linkUrl, '_blank');
                    }
                }
            });
        }
        
        // 6. 文件夹操作按钮绑定
        function bindFolderActionButtons(folder) {
            // 添加子文件夹
            const addChildBtn = folder.querySelector('.add-child-folder');
            if (addChildBtn) {
                addChildBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const folderName = prompt('请输入文件夹名称:');
                    if (folderName) {
                        const subFolderContainer = folder.querySelector('div.pl-6');
                        if (subFolderContainer) {
                            // 显示子文件夹容器
                            subFolderContainer.classList.remove('hidden');
                            
                            // 创建新文件夹
                            const newFolder = document.createElement('div');
                            newFolder.className = 'folder-item';
                            newFolder.id = `folder-${folderIdCounter++}`;
                            
                            newFolder.innerHTML = `
                                <div class="folder-tree-item flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                        <span class="folder-name">${folderName}</span>
                                    </div>
                                    <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                        <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-plus-circle"></i>
                                        </button>
                                        <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-pencil"></i>
                                        </button>
                                        <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="pl-6 mt-1 space-y-1 hidden">
                                    <!-- 子内容将在这里显示 -->
                                </div>
                            `;
                            
                            subFolderContainer.appendChild(newFolder);
                            setupFolderToggle(); // 重新绑定事件
                            
                            // 更新文件夹图标为打开状态
                            const folderIcon = folder.querySelector('.fa-folder');
                            if (folderIcon) {
                                folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                            }
                        }
                    }
                });
            }
            
            // 重命名文件夹
            const renameBtn = folder.querySelector('.rename-folder');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const folderNameElement = folder.querySelector('.folder-name');
                    const currentName = folderNameElement.textContent;
                    const newName = prompt('请输入新文件夹名称:', currentName);
                    if (newName && newName !== currentName) {
                        folderNameElement.textContent = newName;
                    }
                });
            }
            
            // 删除文件夹
            const deleteBtn = folder.querySelector('.delete-folder');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个文件夹吗? 文件夹内的所有内容也将被删除。')) {
                        // 检查是否包含当前打开的文档
                        const docItems = folder.querySelectorAll('.document-item');
                        const hasCurrentDoc = Array.from(docItems).some(item => 
                            item.dataset.document === currentDocument
                        );
                        
                        if (hasCurrentDoc) {
                            // 尝试找到第一个其他文档
                            const firstDoc = document.querySelector('.document-item:not(.document-item[data-document="' + currentDocument + '"])');
                            if (firstDoc) {
                                loadDocument(firstDoc.dataset.document);
                                firstDoc.classList.add('active');
                            } else {
                                // 如果没有其他文档，清空编辑器
                                currentDocument = null;
                                document.getElementById('currentFileName').textContent = '';
                                document.getElementById('editor').innerHTML = '';
                                document.getElementById('attachmentsContainer').innerHTML = '';
                            }
                        }
                        
                        // 从localStorage中删除文档
                        const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
                        docItems.forEach(item => {
                            const docName = item.dataset.document;
                            if (documents[docName]) {
                                delete documents[docName];
                            }
                        });
                        localStorage.setItem('kbm_documents', JSON.stringify(documents));
                        
                        // 从localStorage中删除附件
                        const allAttachments = JSON.parse(localStorage.getItem('kbm_attachments') || '{}');
                        docItems.forEach(item => {
                            const docName = item.dataset.document;
                            if (allAttachments[docName]) {
                                delete allAttachments[docName];
                            }
                        });
                        localStorage.setItem('kbm_attachments', JSON.stringify(allAttachments));
                        
                        // 从DOM中删除文件夹
                        folder.remove();
                    }
                });
            }
        }
        
        // 7. 添加根文件夹
        document.getElementById('addRootFolder').addEventListener('click', () => {
            const folderName = prompt('请输入文件夹名称:');
            if (folderName) {
                const folderTree = document.getElementById('folderTree');
                
                const newFolder = document.createElement('div');
                newFolder.className = 'folder-item';
                newFolder.id = `folder-${folderIdCounter++}`;
                
                newFolder.innerHTML = `
                    <div class="folder-tree-item flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-folder text-yellow-500 mr-2"></i>
                            <span class="folder-name">${folderName}</span>
                        </div>
                        <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                            <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                <i class="fa fa-plus-circle"></i>
                            </button>
                            <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pl-6 mt-1 space-y-1 hidden">
                        <!-- 子内容将在这里显示 -->
                    </div>
                `;
                
                folderTree.appendChild(newFolder);
                setupFolderToggle(); // 重新绑定事件
            }
        });
        
        // 8. 添加新文档
        document.getElementById('addDocument').addEventListener('click', () => {
            const docName = prompt('请输入文档名称 (不需要.md扩展名):', `新文档${documentIdCounter++}`);
            if (docName) {
                const fullDocName = `${docName}.md`;
                const folderTree = document.getElementById('folderTree');
                
                // 创建新文档项
                const newDoc = document.createElement('div');
                newDoc.className = 'folder-tree-item flex items-center justify-between document-item';
                newDoc.dataset.document = fullDocName;
                
                newDoc.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                        <span class="document-name">${fullDocName}</span>
                    </div>
                    <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                        <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                            <i class="fa fa-arrows"></i>
                        </button>
                        <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // 添加到第一个文件夹
                const firstFolder = folderTree.querySelector('.folder-item div.pl-6');
                if (firstFolder) {
                    firstFolder.classList.remove('hidden');
                    firstFolder.appendChild(newDoc);
                    
                    // 更新文件夹图标为打开状态
                    const folderIcon = firstFolder.parentElement.querySelector('.fa-folder');
                    if (folderIcon) {
                        folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                    }
                } else {
                    // 如果没有文件夹，直接添加到根目录
                    folderTree.appendChild(newDoc);
                }
                
                // 绑定文档操作事件
                setupFolderToggle();
                
                // 创建默认文档内容并保存
                saveDocumentContent(fullDocName, `# ${docName}\n\n请在此处输入文档内容...`);
                
                // 加载新文档
                loadDocument(fullDocName);
                
                // 更新活跃状态
                document.querySelectorAll('.folder-tree-item').forEach(el => {
                    el.classList.remove('active');
                });
                newDoc.classList.add('active');
            }
        });
        
        // 9. 编辑器工具栏按钮功能
        document.querySelectorAll('.editor-toolbar-btn[data-command]').forEach(button => {
            button.addEventListener('click', () => {
                const command = button.getAttribute('data-command');
                
                if (command === 'createLink') {
                    const url = prompt('请输入链接地址:');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else if (command === 'insertImage') {
                    const url = prompt('请输入图片URL:');
                    if (url) {
                        document.execCommand(command, false, url);
                    }
                } else {
                    document.execCommand(command, false, null);
                }
                
                // 触发保存
                saveDocument();
            });
        });
        
        // 10. 字体和字号设置 - 修复字体大小导致的空行问题
        document.getElementById('fontFamily').addEventListener('change', (e) => {
            document.execCommand('fontName', false, e.target.value);
            saveDocument();
        });
        
        document.getElementById('fontSize').addEventListener('change', (e) => {
            const fontSize = e.target.value;
            const selection = window.getSelection();
            
            // 检查是否有选中内容
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                
                // 检查选中的内容是否已经在一个span标签中
                let span;
                if (range.startContainer.parentNode.tagName === 'SPAN' && 
                    range.startContainer.parentNode.style.fontSize) {
                    // 如果已有span，直接修改其样式
                    span = range.startContainer.parentNode;
                    span.style.fontSize = fontSize;
                } else {
                    // 没有span则创建一个新的
                    span = document.createElement('span');
                    span.style.fontSize = fontSize;
                    
                    // 保存选中的内容
                    const fragment = range.extractContents();
                    span.appendChild(fragment);
                    
                    // 将span插入回文档
                    range.insertNode(span);
                    
                    // 重新选中内容
                    range.setStartBefore(span);
                    range.setEndAfter(span);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            } else {
                // 如果没有选中文本，设置一个格式化块用于后续输入
                document.execCommand('formatBlock', false, '<span>');
                const span = window.getSelection().focusNode.parentNode;
                if (span.tagName === 'SPAN') {
                    span.style.fontSize = fontSize;
                }
            }
            
            saveDocument();
        });
        
        // 11. 颜色选择功能
        const colors = [
            '#000000', '#333333', '#666666', '#999999', '#CCCCCC', '#EEEEEE', '#FFFFFF',
            '#FF0000', '#FF9900', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF', '#9900FF', '#FF00FF',
            '#FF6666', '#FFCC99', '#FFFF99', '#CCFF99', '#99FFFF', '#99CCFF', '#CC99FF', '#FF99CC'
        ];
        
        // 创建颜色选择面板
        function createColorPalette(containerId, command) {
            const container = document.getElementById(containerId);
            const palette = container.querySelector('div.grid');
            
            colors.forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.className = 'color-btn';
                colorBtn.style.backgroundColor = color;
                
                // 根据背景色自动选择文本颜色（黑或白）
                const isDark = (parseInt(color.slice(1), 16) >> 22) < 32;
                colorBtn.innerHTML = `<span style="color: ${isDark ? 'white' : 'black'}">●</span>`;
                
                colorBtn.addEventListener('click', () => {
                    document.execCommand(command, false, color);
                    // 更新颜色指示器
                    container.querySelector('.color-indicator').style.backgroundColor = color;
                    // 隐藏面板
                    palette.parentElement.classList.add('hidden');
                    // 保存文档
                    saveDocument();
                });
                
                palette.appendChild(colorBtn);
            });
            
            // 点击颜色按钮显示面板
            container.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                palette.parentElement.classList.toggle('hidden');
            });
        }
        
        // 创建文本颜色和背景颜色选择面板
        createColorPalette('foreColorContainer', 'foreColor');
        createColorPalette('hiliteColorContainer', 'hiliteColor');
        
        // 点击页面其他地方隐藏颜色面板
        document.addEventListener('click', () => {
            document.getElementById('foreColorPalette').classList.add('hidden');
            document.getElementById('hiliteColorPalette').classList.add('hidden');
        });
        
        // 12. 附件上传功能
        const addAttachmentBtn = document.getElementById('addAttachment');
        const attachmentInput = document.getElementById('attachmentInput');
        const attachmentsContainer = document.getElementById('attachmentsContainer');
        
        addAttachmentBtn.addEventListener('click', () => {
            attachmentInput.click();
        });
        
        attachmentInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length) {
                for (let i = 0; i < files.length; i++) {
                    addAttachment(files[i]);
                }
                // 清空input值，允许重复上传同一文件
                attachmentInput.value = '';
                // 保存附件信息
                saveAttachments();
            }
        });
        
        function addAttachment(file) {
            // 格式化文件大小
            const formatFileSize = (bytes) => {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            };
            
            const attachmentId = `attachment-${attachmentIdCounter++}`;
            const fileSize = formatFileSize(file.size);
            
            const attachment = document.createElement('div');
            attachment.className = 'file-attachment';
            attachment.dataset.id = attachmentId;
            attachment.dataset.name = file.name;
            attachment.dataset.size = fileSize;
            
            // 确定文件图标
            const fileExtension = file.name.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file-o';
            
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(fileExtension)) {
                fileIcon = 'fa-file-image-o';
            } else if (['pdf'].includes(fileExtension)) {
                fileIcon = 'fa-file-pdf-o';
            } else if (['doc', 'docx'].includes(fileExtension)) {
                fileIcon = 'fa-file-word-o';
            } else if (['xls', 'xlsx'].includes(fileExtension)) {
                fileIcon = 'fa-file-excel-o';
            } else if (['ppt', 'pptx'].includes(fileExtension)) {
                fileIcon = 'fa-file-powerpoint-o';
            } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                fileIcon = 'fa-file-archive-o';
            } else if (['txt', 'md', 'html', 'css', 'js'].includes(fileExtension)) {
                fileIcon = 'fa-file-text-o';
            }
            
            attachment.innerHTML = `
                <div class="file-icon">
                    <i class="fa ${fileIcon} text-xl"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${fileSize}</div>
                </div>
                <button class="delete-attachment text-gray-500 dark:text-gray-400 hover:text-red-500">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            attachmentsContainer.appendChild(attachment);
            
            // 绑定删除附件事件
            attachment.querySelector('.delete-attachment').addEventListener('click', () => {
                attachment.remove();
                saveAttachments();
            });
        }
        
        // 13. 保存功能实现
        const saveButton = document.getElementById('saveButton');
        const saveIndicator = document.getElementById('saveIndicator');
        const editor = document.getElementById('editor');
        
        // 显示保存成功提示
        function showSaveIndicator() {
            saveIndicator.style.opacity = '1';
            setTimeout(() => {
                saveIndicator.style.opacity = '0';
            }, 2000);
        }
        
        // 保存当前文档内容到localStorage
        function saveDocumentContent(docName, content) {
            const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
            documents[docName] = content;
            localStorage.setItem('kbm_documents', JSON.stringify(documents));
        }
        
        // 保存当前文档
        function saveDocument() {
            if (!currentDocument) return;
            
            const content = editor.innerHTML;
            saveDocumentContent(currentDocument, content);
            showSaveIndicator();
        }
        
        // 保存附件信息
        function saveAttachments() {
            if (!currentDocument) return;
            
            const attachments = [];
            document.querySelectorAll('.file-attachment').forEach(att => {
                attachments.push({
                    id: att.dataset.id,
                    name: att.dataset.name,
                    size: att.dataset.size
                });
            });
            
            const allAttachments = JSON.parse(localStorage.getItem('kbm_attachments') || '{}');
            allAttachments[currentDocument] = attachments;
            localStorage.setItem('kbm_attachments', JSON.stringify(allAttachments));
        }
        
        // 加载文档
        function loadDocument(docName) {
            currentDocument = docName;
            document.getElementById('currentFileName').textContent = docName;
            
            // 加载文档内容
            const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
            editor.innerHTML = documents[docName] || `# ${docName.replace('.md', '')}\n\n请在此处输入文档内容...`;
            
            // 加载附件
            loadAttachments();
        }
        
        // 加载附件
        function loadAttachments() {
            if (!currentDocument) return;
            
            // 清空现有附件
            attachmentsContainer.innerHTML = '';
            
            const allAttachments = JSON.parse(localStorage.getItem('kbm_attachments') || '{}');
            const attachments = allAttachments[currentDocument] || [];
            
            attachments.forEach(att => {
                const attachment = document.createElement('div');
                attachment.className = 'file-attachment';
                attachment.dataset.id = att.id;
                attachment.dataset.name = att.name;
                attachment.dataset.size = att.size;
                
                // 确定文件图标
                const fileExtension = att.name.split('.').pop().toLowerCase();
                let fileIcon = 'fa-file-o';
                
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(fileExtension)) {
                    fileIcon = 'fa-file-image-o';
                } else if (['pdf'].includes(fileExtension)) {
                    fileIcon = 'fa-file-pdf-o';
                } else if (['doc', 'docx'].includes(fileExtension)) {
                    fileIcon = 'fa-file-word-o';
                } else if (['xls', 'xlsx'].includes(fileExtension)) {
                    fileIcon = 'fa-file-excel-o';
                } else if (['ppt', 'pptx'].includes(fileExtension)) {
                    fileIcon = 'fa-file-powerpoint-o';
                } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                    fileIcon = 'fa-file-archive-o';
                } else if (['txt', 'md', 'html', 'css', 'js'].includes(fileExtension)) {
                    fileIcon = 'fa-file-text-o';
                }
                
                attachment.innerHTML = `
                    <div class="file-icon">
                        <i class="fa ${fileIcon} text-xl"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${att.name}</div>
                        <div class="file-size">${att.size}</div>
                    </div>
                    <button class="delete-attachment text-gray-500 dark:text-gray-400 hover:text-red-500">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                attachmentsContainer.appendChild(attachment);
                
                // 绑定删除附件事件
                attachment.querySelector('.delete-attachment').addEventListener('click', () => {
                    attachment.remove();
                    saveAttachments();
                });
            });
        }
        
        // 绑定保存按钮事件
        saveButton.addEventListener('click', saveDocument);
        
        // 编辑器内容变化时自动保存
        editor.addEventListener('input', saveDocument);
        
        // 页面加载时加载默认文档
        window.addEventListener('DOMContentLoaded', () => {
            // 初始化文件夹切换
            setupFolderToggle();
            
            // 加载默认文档
            loadDocument('项目计划.md');
            
            // 为初始文档创建默认内容（如果不存在）
            const documents = JSON.parse(localStorage.getItem('kbm_documents') || '{}');
            if (!documents['项目计划.md']) {
                saveDocumentContent('项目计划.md', editor.innerHTML);
            }
        });
        
        // 页面关闭前确保保存
        window.addEventListener('beforeunload', saveDocument);
    </script>
</body>
</html>
