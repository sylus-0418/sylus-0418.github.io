<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#6B7280',
                        neutral: '#F3F4F6',
                        dark: '#1F2937',
                        light: '#F9FAFB',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                        weiyaruhei: ['"Microsoft YaHei"', 'sans-serif'],
                        song: ['"SimSun"', 'serif'],
                        kai: ['"KaiTi"', 'serif'],
                        hei: ['"SimHei"', 'sans-serif'],
                        fang: ['"FangSong"', 'serif'],
                        times: ['"Times New Roman"', 'serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .folder-tree-item {
                @apply py-1 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors duration-150;
            }
            .folder-tree-item.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .editor-toolbar-btn {
                @apply p-2 rounded transition-all duration-150 flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700;
            }
            .editor-toolbar-btn.active {
                @apply ring-2 ring-primary/50 bg-primary/10 text-primary;
            }
            .color-btn {
                @apply w-8 h-8 rounded-full flex items-center justify-center transition-transform hover:scale-110 border border-gray-200 dark:border-gray-600 cursor-pointer;
            }
            .color-indicator {
                @apply w-4 h-4 rounded-full inline-block mr-1;
            }
            .file-attachment {
                @apply flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg my-2 border border-gray-200 dark:border-gray-600;
            }
            .file-icon {
                @apply text-gray-500 dark:text-gray-400 mr-3;
            }
            .file-info {
                @apply flex-1;
            }
            .file-name {
                @apply font-medium;
            }
            .file-size {
                @apply text-sm text-gray-500 dark:text-gray-400;
            }
            .resizer {
                @apply w-1 bg-gray-300 dark:bg-gray-600 cursor-col-resize hover:bg-primary transition-colors duration-200 relative z-10;
            }
            .resizer::before {
                content: '';
                @apply absolute top-0 left-1/2 -translate-x-1/2 h-full w-3 cursor-col-resize;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200 h-screen flex overflow-hidden transition-colors duration-300">
    <!-- 主容器 -->
    <div class="flex flex-col md:flex-row w-full h-full overflow-hidden">
        <!-- 左侧导航区 -->
        <div id="leftPanel" class="w-full md:w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col h-full overflow-hidden transition-colors duration-300">
            <!-- 左侧标签切换 -->
            <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button id="folderTab" class="flex-1 py-3 px-4 text-center font-medium text-primary border-b-2 border-primary">
                    <i class="fa fa-folder mr-2"></i>文件夹
                </button>
                <button id="linkTab" class="flex-1 py-3 px-4 text-center font-medium text-gray-500 dark:text-gray-400 hover:text-primary transition-colors">
                    <i class="fa fa-link mr-2"></i>链接
                </button>
            </div>
            
            <!-- 文件夹内容区 -->
            <div id="folderContent" class="flex-1 overflow-y-auto scrollbar-hide p-3">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">文件夹列表</h3>
                    <button id="addRootFolder" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary hover:bg-primary/10 rounded transition-colors">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                
                <!-- 文件夹树结构 -->
                <div id="folderTree" class="space-y-1 text-sm">
                    <!-- 初始文件夹示例 -->
                    <div class="folder-item" id="folder-1">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder-open text-yellow-500 mr-2"></i>
                                <span class="folder-name">项目文档</span>
                            </div>
                            <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pl-6 mt-1 space-y-1">
                            <div class="folder-tree-item flex items-center justify-between document-item" data-id="doc-1">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">项目计划.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="folder-item" id="folder-2">
                                <div class="folder-tree-item flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                        <span class="folder-name">需求分析</span>
                                    </div>
                                    <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                        <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-plus-circle"></i>
                                        </button>
                                        <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                            <i class="fa fa-pencil"></i>
                                        </button>
                                        <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="pl-6 mt-1 space-y-1 hidden">
                                    <div class="folder-tree-item flex items-center justify-between document-item" data-id="doc-2">
                                        <div class="flex items-center">
                                            <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                            <span class="document-name">用户需求.md</span>
                                        </div>
                                        <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                            <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                                <i class="fa fa-pencil"></i>
                                            </button>
                                            <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                                <i class="fa fa-arrows"></i>
                                            </button>
                                            <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="folder-item" id="folder-3">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                <span class="folder-name">技术文档</span>
                            </div>
                            <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <!-- 技术文档的子内容 -->
                        <div class="pl-6 mt-1 space-y-1 hidden">
                            <div class="folder-tree-item flex items-center justify-between document-item" data-id="doc-3">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">架构设计.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="folder-tree-item flex items-center justify-between document-item" data-id="doc-4">
                                <div class="flex items-center">
                                    <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                                    <span class="document-name">API文档.md</span>
                                </div>
                                <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-arrows"></i>
                                    </button>
                                    <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 添加文档按钮 -->
                <div class="mt-4">
                    <button id="addDocument" class="w-full py-2 px-3 border border-dashed border-gray-300 dark:border-gray-600 rounded text-gray-500 dark:text-gray-400 hover:border-primary hover:text-primary transition-colors flex items-center justify-center">
                        <i class="fa fa-file-text-o mr-2"></i>添加新文档
                    </button>
                </div>
            </div>
            
            <!-- 链接内容区 (默认隐藏) -->
            <div id="linkContent" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium text-gray-700 dark:text-gray-300">链接列表</h3>
                    <button id="addLink" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-primary hover:bg-primary/10 rounded transition-colors">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                
                <div id="linkTree" class="space-y-1 text-sm">
                    <!-- 链接可以有层级结构 -->
                    <div class="link-item" id="link-folder-1">
                        <div class="folder-tree-item flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                <span class="link-folder-name">外部资源</span>
                            </div>
                            <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                                <button class="add-child-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-plus-circle"></i>
                                </button>
                                <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="pl-6 mt-1 space-y-1 hidden">
                            <div class="folder-tree-item flex items-center justify-between cursor-pointer">
                                <div class="flex items-center">
                                    <i class="fa fa-external-link text-blue-500 mr-2"></i>
                                    <span class="link-name">官方文档</span>
                                </div>
                                <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="insert-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-clipboard"></i>
                                    </button>
                                    <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 可拖拽分隔线 -->
        <div id="resizer" class="resizer md:block hidden"></div>
        
        <!-- 右侧编辑/预览区 -->
        <div id="rightPanel" class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-900 h-full overflow-hidden transition-colors duration-300">
            <!-- 顶部控制栏 -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 flex justify-between items-center">
                <div class="flex items-center">
                    <button id="toggleEditorToolbar" class="editor-toolbar-btn mr-1">
                        <i class="fa fa-wrench"></i>
                    </button>
                    <span id="currentFileName" class="text-sm text-gray-500 dark:text-gray-400">项目计划.md</span>
                </div>
                <div class="flex items-center">
                    <div class="flex border border-gray-300 dark:border-gray-600 rounded overflow-hidden mr-2">
                        <button id="editModeBtn" class="editor-toolbar-btn active px-3">
                            <i class="fa fa-edit mr-1"></i>编辑
                        </button>
                        <button id="previewModeBtn" class="editor-toolbar-btn px-3">
                            <i class="fa fa-eye mr-1"></i>预览
                        </button>
                        <button id="splitModeBtn" class="editor-toolbar-btn px-3">
                            <i class="fa fa-columns mr-1"></i>分屏
                        </button>
                    </div>
                    <button id="themeToggle" class="editor-toolbar-btn mr-1">
                        <i class="fa fa-moon-o dark:hidden"></i>
                        <i class="fa fa-sun-o hidden dark:inline-block"></i>
                    </button>
                    <button id="saveBtn" class="editor-toolbar-btn">
                        <i class="fa fa-save"></i>
                    </button>
                </div>
            </div>
            
            <!-- 编辑器工具栏 -->
            <div id="editorToolbar" class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-2 transition-all duration-300">
                <div class="flex flex-wrap gap-1">
                    <!-- 字体选择 -->
                    <select id="fontFamily" class="editor-toolbar-btn border border-gray-200 dark:border-gray-600 rounded px-2 h-9 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        <option value="Inter, sans-serif">Inter</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
                        <option value="SimSun, serif">宋体</option>
                    </select>
                    
                    <!-- 字号选择 -->
                    <select id="fontSize" class="editor-toolbar-btn border border-gray-200 dark:border-gray-600 rounded px-2 h-9 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                        <option value="12px">极小</option>
                        <option value="14px">小</option>
                        <option value="16px" selected>中</option>
                        <option value="18px">大</option>
                        <option value="24px">较大</option>
                    </select>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本格式 -->
                    <button class="editor-toolbar-btn" title="粗体" data-command="bold">
                        <i class="fa fa-bold"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="斜体" data-command="italic">
                        <i class="fa fa-italic"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="下划线" data-command="underline">
                        <i class="fa fa-underline"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本对齐 -->
                    <button class="editor-toolbar-btn" title="左对齐" data-command="justifyLeft">
                        <i class="fa fa-align-left"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="居中对齐" data-command="justifyCenter">
                        <i class="fa fa-align-center"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="右对齐" data-command="justifyRight">
                        <i class="fa fa-align-right"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 列表 -->
                    <button class="editor-toolbar-btn" title="无序列表" data-command="insertUnorderedList">
                        <i class="fa fa-list-ul"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="有序列表" data-command="insertOrderedList">
                        <i class="fa fa-list-ol"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="减少缩进" data-command="outdent">
                        <i class="fa fa-outdent"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="增加缩进" data-command="indent">
                        <i class="fa fa-indent"></i>
                    </button>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 文本颜色 -->
                    <div class="relative" id="foreColorContainer">
                        <button id="foreColor" class="editor-toolbar-btn" title="文本颜色">
                            <span class="color-indicator bg-black dark:bg-white"></span>
                            <i class="fa fa-font"></i>
                        </button>
                        <div id="foreColorPalette" class="hidden absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 p-2 rounded shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="grid grid-cols-8 gap-1">
                                <!-- 颜色选项会通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 背景颜色 -->
                    <div class="relative" id="hiliteColorContainer">
                        <button id="hiliteColor" class="editor-toolbar-btn" title="背景颜色">
                            <span class="color-indicator bg-yellow-200 dark:bg-yellow-800"></span>
                            <i class="fa fa-highlighter"></i>
                        </button>
                        <div id="hiliteColorPalette" class="hidden absolute top-full left-0 mt-1 bg-white dark:bg-gray-800 p-2 rounded shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="grid grid-cols-8 gap-1">
                                <!-- 颜色选项会通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="h-8 border-r border-gray-300 dark:border-gray-600 mx-1"></div>
                    
                    <!-- 插入功能 -->
                    <button class="editor-toolbar-btn" title="插入链接" data-command="createLink">
                        <i class="fa fa-link"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="插入图片" data-command="insertImage">
                        <i class="fa fa-image"></i>
                    </button>
                    <button class="editor-toolbar-btn" title="插入表格">
                        <i class="fa fa-table"></i>
                    </button>
                </div>
            </div>
            
            <!-- 编辑器内容区 -->
            <div class="flex-1 flex overflow-hidden">
                <div id="editorContainer" class="flex-1 overflow-y-auto p-6 bg-white dark:bg-gray-800 m-4 rounded-lg shadow-sm transition-colors duration-300">
                    <div id="editor" class="min-h-full" contenteditable="true">
                        <h1 class="text-2xl font-bold mb-4">项目计划文档</h1>
                        <p class="mb-4">本文档详细描述了项目的整体计划和时间安排，包括以下几个部分：</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">1. 项目背景</h2>
                        <p class="mb-4">该项目旨在开发一个高效的知识库管理系统，帮助团队更好地管理和共享文档资源。</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">2. 项目目标</h2>
                        <ul class="list-disc pl-6 mb-4">
                            <li>建立结构化的文档管理系统</li>
                            <li>支持Markdown格式编辑与预览</li>
                            <li>实现文档的快速检索功能</li>
                            <li>支持多人协作编辑</li>
                        </ul>
                    </div>
                    
                    <!-- 附件上传区域 -->
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="addAttachment" class="editor-toolbar-btn mb-3">
                            <i class="fa fa-paperclip mr-2"></i>添加附件
                        </button>
                        <input type="file" id="attachmentInput" class="hidden" multiple>
                        <div id="attachmentsContainer" class="space-y-2">
                            <!-- 附件会在这里显示 -->
                        </div>
                    </div>
                </div>
                
                <div id="previewContainer" class="hidden flex-1 overflow-y-auto p-6 bg-white dark:bg-gray-800 m-4 rounded-lg shadow-sm transition-colors duration-300 border-l border-gray-200 dark:border-gray-700">
                    <div id="previewContent" class="min-h-full">
                        <!-- 预览内容将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let folderIdCounter = 4;
        let documentIdCounter = 5; // 从5开始，因为已有4个默认文档
        let linkIdCounter = 1;
        let attachmentIdCounter = 1;
        let currentDocumentId = 'doc-1'; // 当前打开的文档ID
        let currentMode = 'edit'; // 编辑模式: edit, preview, split
        
        // 初始化 - 从本地存储加载数据
        function init() {
            loadDocumentsFromStorage();
            setupModeButtons();
            updatePreview();
            setupEventListeners();
            initColorPalettes(); // 初始化颜色选择器
        }
        
        // 1. 主题切换功能
        const themeToggle = document.getElementById('themeToggle');
        
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        });
        
        // 2. 工具栏切换
        const toggleEditorToolbar = document.getElementById('toggleEditorToolbar');
        const editorToolbar = document.getElementById('editorToolbar');
        
        toggleEditorToolbar.addEventListener('click', () => {
            editorToolbar.classList.toggle('hidden');
        });
        
        // 3. 左侧标签切换
        const folderTab = document.getElementById('folderTab');
        const linkTab = document.getElementById('linkTab');
        const folderContent = document.getElementById('folderContent');
        const linkContent = document.getElementById('linkContent');
        
        folderTab.addEventListener('click', () => {
            folderTab.classList.add('text-primary', 'border-b-2', 'border-primary');
            folderTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            linkTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
            linkTab.classList.add('text-gray-500', 'dark:text-gray-400');
            folderContent.classList.remove('hidden');
            linkContent.classList.add('hidden');
        });
        
        linkTab.addEventListener('click', () => {
            linkTab.classList.add('text-primary', 'border-b-2', 'border-primary');
            linkTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            folderTab.classList.remove('text-primary', 'border-b-2', 'border-primary');
            folderTab.classList.add('text-gray-500', 'dark:text-gray-400');
            linkContent.classList.remove('hidden');
            folderContent.classList.add('hidden');
        });
        
        // 4. 文件夹展开/折叠功能
        function setupFolderToggle() {
            // 文件夹展开/折叠
            document.querySelectorAll('.folder-item').forEach(folder => {
                const folderHeader = folder.querySelector('.folder-tree-item');
                const subItems = folder.querySelector('div.pl-6');
                
                // 确保每个文件夹都有点击事件
                folderHeader.addEventListener('click', (e) => {
                    if (!e.target.closest('.folder-actions')) {
                        subItems.classList.toggle('hidden');
                        const folderIcon = folderHeader.querySelector('.fa-folder, .fa-folder-open');
                        if (folderIcon) {
                            folderIcon.classList.toggle('fa-folder');
                            folderIcon.classList.toggle('fa-folder-open');
                        }
                    }
                });
                
                bindFolderActionButtons(folder);
            });
            
            // 链接文件夹展开/折叠
            document.querySelectorAll('.link-item').forEach(linkFolder => {
                const folderHeader = linkFolder.querySelector('.folder-tree-item');
                const subItems = linkFolder.querySelector('div.pl-6');
                
                folderHeader.addEventListener('click', (e) => {
                    if (!e.target.closest('.link-actions')) {
                        subItems.classList.toggle('hidden');
                        const folderIcon = folderHeader.querySelector('.fa-folder, .fa-folder-open');
                        if (folderIcon) {
                            folderIcon.classList.toggle('fa-folder');
                            folderIcon.classList.toggle('fa-folder-open');
                        }
                    }
                });
                
                bindLinkActionButtons(linkFolder);
            });
            
            // 文档点击事件 - 加载文档内容
document.querySelectorAll('.document-item').forEach(item => {
    item.addEventListener('click', () => {
        // 保存当前文档
        saveCurrentDocument(false); // 添加false参数，不显示保存提示
        
        // 切换选中状态
        document.querySelectorAll('.document-item').forEach(i => {
            i.classList.remove('active');
        });
        item.classList.add('active');
        
        // 加载新文档
        currentDocumentId = item.dataset.id;
        loadDocument(currentDocumentId);
        
        // 更新文件名显示
        const fileName = item.querySelector('.document-name').textContent;
        document.getElementById('currentFileName').textContent = fileName;
    });
});
        }
        
        // 5. 链接分区功能实现
        document.getElementById('addLink').addEventListener('click', () => {
            const linkName = prompt('请输入链接名称:', `新链接${linkIdCounter}`);
            if (linkName) {
                const linkUrl = prompt('请输入链接地址:');
                if (linkUrl) {
                    addNewLink(linkName, linkUrl, document.getElementById('linkTree'));
                }
            }
        });
        
        function addNewLink(linkName, linkUrl, parentContainer) {
            const linkItem = document.createElement('div');
            linkItem.className = 'folder-tree-item flex items-center justify-between cursor-pointer';
            linkItem.dataset.url = linkUrl;
            
            linkItem.innerHTML = `
                <div class="flex items-center">
                    <i class="fa fa-external-link text-blue-500 mr-2"></i>
                    <span class="link-name">${linkName}</span>
                </div>
                <div class="link-actions opacity-0 hover:opacity-100 transition-opacity">
                    <button class="rename-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                        <i class="fa fa-pencil"></i>
                    </button>
                    <button class="insert-link p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                        <i class="fa fa-clipboard"></i>
                    </button>
                    <button class="delete-link p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            `;
            
            parentContainer.appendChild(linkItem);
            bindLinkItemActionButtons(linkItem);
        }
        
        function bindLinkActionButtons(linkFolder) {
            // 添加子链接
            const addChildBtn = linkFolder.querySelector('.add-child-link');
            if (addChildBtn) {
                addChildBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const linkName = prompt('请输入链接名称:');
                    if (linkName) {
                        const linkUrl = prompt('请输入链接地址:');
                        if (linkUrl) {
                            const subLinkContainer = linkFolder.querySelector('div.pl-6');
                            addNewLink(linkName, linkUrl, subLinkContainer);
                            
                            // 显示子链接容器
                            subLinkContainer.classList.remove('hidden');
                            const folderIcon = linkFolder.querySelector('.fa-folder');
                            if (folderIcon) {
                                folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                            }
                        }
                    }
                });
            }
            
            // 重命名链接文件夹
            const renameBtn = linkFolder.querySelector('.rename-link');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentName = linkFolder.querySelector('.link-folder-name').textContent;
                    const newName = prompt('请输入新名称:', currentName);
                    if (newName && newName !== currentName) {
                        linkFolder.querySelector('.link-folder-name').textContent = newName;
                    }
                });
            }
            
            // 删除链接文件夹
            const deleteBtn = linkFolder.querySelector('.delete-link');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个链接文件夹吗？')) {
                        linkFolder.remove();
                    }
                });
            }
        }
        
        function bindLinkItemActionButtons(linkItem) {
            // 重命名链接
            const renameBtn = linkItem.querySelector('.rename-link');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentName = linkItem.querySelector('.link-name').textContent;
                    const newName = prompt('请输入新名称:', currentName);
                    if (newName && newName !== currentName) {
                        linkItem.querySelector('.link-name').textContent = newName;
                    }
                });
            }
            
            // 插入链接到文档
            const insertBtn = linkItem.querySelector('.insert-link');
            if (insertBtn) {
                insertBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const linkUrl = linkItem.dataset.url;
                    const linkName = linkItem.querySelector('.link-name').textContent;
                    
                    // 插入链接到编辑器
                    document.execCommand('insertHTML', false, `<a href="${linkUrl}" target="_blank">${linkName}</a>`);
                    
                    // 自动保存
                    saveCurrentDocument();
                    updatePreview();
                });
            }
            
            // 删除链接
            const deleteBtn = linkItem.querySelector('.delete-link');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个链接吗？')) {
                        linkItem.remove();
                    }
                });
            }
            
            // 点击链接打开
            linkItem.addEventListener('click', (e) => {
                if (!e.target.closest('.link-actions')) {
                    const url = linkItem.dataset.url;
                    if (url) {
                        window.open(url, '_blank');
                    }
                }
            });
        }
        
        // 6. 文档管理功能 - 本地存储实现
        function getDocuments() {
            const docs = localStorage.getItem('knowledgeBaseDocuments');
            return docs ? JSON.parse(docs) : {
                'doc-1': {
                    name: '项目计划.md',
                    content: `
                        <h1 class="text-2xl font-bold mb-4">项目计划文档</h1>
                        <p class="mb-4">本文档详细描述了项目的整体计划和时间安排，包括以下几个部分：</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">1. 项目背景</h2>
                        <p class="mb-4">该项目旨在开发一个高效的知识库管理系统，帮助团队更好地管理和共享文档资源。</p>
                        
                        <h2 class="text-xl font-bold mt-6 mb-3">2. 项目目标</h2>
                        <ul class="list-disc pl-6 mb-4">
                            <li>建立结构化的文档管理系统</li>
                            <li>支持Markdown格式编辑与预览</li>
                            <li>实现文档的快速检索功能</li>
                            <li>支持多人协作编辑</li>
                        </ul>
                    `.trim(),
                    attachments: []
                },
                'doc-2': {
                    name: '用户需求.md',
                    content: `<h1 class="text-2xl font-bold mb-4">用户需求文档</h1>
                        <p class="mb-4">本文档描述了系统的用户需求和功能点。</p>`,
                    attachments: []
                },
                'doc-3': {
                    name: '架构设计.md',
                    content: `<h1 class="text-2xl font-bold mb-4">架构设计文档</h1>
                        <p class="mb-4">本文档描述了系统的技术架构和实现方案。</p>`,
                    attachments: []
                },
                'doc-4': {
                    name: 'API文档.md',
                    content: `<h1 class="text-2xl font-bold mb-4">API接口文档</h1>
                        <p class="mb-4">本文档描述了系统提供的API接口和使用方法。</p>`,
                    attachments: []
                }
            };
        }
        
        function saveDocuments(docs) {
            localStorage.setItem('knowledgeBaseDocuments', JSON.stringify(docs));
        }
        
        function loadDocumentsFromStorage() {
            // 首次加载时无需额外操作，因为getDocuments()会处理默认值
            // 标记当前文档为活跃状态
            document.querySelector(`.document-item[data-id="${currentDocumentId}"]`).classList.add('active');
        }
        
        function loadDocument(docId) {
            const docs = getDocuments();
            const doc = docs[docId];
            
            if (doc) {
                // 加载文档内容
                document.getElementById('editor').innerHTML = doc.content || '';
                
                // 加载附件
                const attachmentsContainer = document.getElementById('attachmentsContainer');
                attachmentsContainer.innerHTML = '';
                
                if (doc.attachments && doc.attachments.length > 0) {
                    doc.attachments.forEach(attachment => {
                        addAttachmentToUI(attachment.id, attachment.name, attachment.size);
                    });
                }
                
                // 更新预览
                updatePreview();
            }
        }
        
        function saveCurrentDocument(showNotification = true) {
            const docs = getDocuments();
            const content = document.getElementById('editor').innerHTML;
            const fileName = document.getElementById('currentFileName').textContent;
            
            // 收集附件信息
            const attachments = [];
            document.querySelectorAll('.file-attachment').forEach(attach => {
                attachments.push({
                    id: attach.dataset.id,
                    name: attach.querySelector('.file-name').textContent,
                    size: attach.querySelector('.file-size').textContent
                });
            });
            
            // 更新或创建文档
            if (!docs[currentDocumentId]) {
                docs[currentDocumentId] = { name: fileName, content, attachments };
            } else {
                docs[currentDocumentId].content = content;
                docs[currentDocumentId].name = fileName;
                docs[currentDocumentId].attachments = attachments;
            }
            
            // 保存到本地存储
            saveDocuments(docs);
            
            // 显示保存提示（可控制是否显示）
            if (showNotification) {
                showSaveNotification();
            }
        }
        
        function showSaveNotification() {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-primary text-white px-4 py-2 rounded shadow-lg z-50 transition-all duration-300 transform translate-y-20 opacity-0';
            notification.textContent = '文档已保存';
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // 7. 添加新文档功能
        document.getElementById('addDocument').addEventListener('click', () => {
            const docName = prompt('请输入文档名称:', `新文档${documentIdCounter}.md`);
            if (docName) {
                // 保存当前文档
                saveCurrentDocument();
                
                // 创建新文档ID
                const newDocId = `doc-${documentIdCounter}`;
                documentIdCounter++;
                
                // 添加到文档列表
                const folderTree = document.getElementById('folderTree');
                const firstFolder = folderTree.querySelector('.folder-item');
                const subItems = firstFolder.querySelector('div.pl-6');
                
                // 如果没有子项目容器，创建一个
                if (!subItems) {
                    const subContainer = document.createElement('div');
                    subContainer.className = 'pl-6 mt-1 space-y-1';
                    firstFolder.appendChild(subContainer);
                }
                
                // 创建新文档元素
                const newDocElement = document.createElement('div');
                newDocElement.className = 'folder-tree-item flex items-center justify-between document-item active';
                newDocElement.dataset.id = newDocId;
                newDocElement.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-file-text-o text-gray-400 mr-2"></i>
                        <span class="document-name">${docName}</span>
                    </div>
                    <div class="document-actions opacity-0 hover:opacity-100 transition-opacity">
                        <button class="rename-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="move-document p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                            <i class="fa fa-arrows"></i>
                        </button>
                        <button class="delete-document p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // 添加到DOM
                firstFolder.querySelector('div.pl-6').appendChild(newDocElement);
                
                // 清除其他文档的活跃状态
                document.querySelectorAll('.document-item').forEach(item => {
                    if (item.dataset.id !== newDocId) {
                        item.classList.remove('active');
                    }
                });
                
                // 添加到本地存储
                const docs = getDocuments();
                docs[newDocId] = {
                    name: docName,
                    content: '',
                    attachments: []
                };
                saveDocuments(docs);
                
                // 切换到新文档
                currentDocumentId = newDocId;
                document.getElementById('currentFileName').textContent = docName;
                document.getElementById('editor').innerHTML = '';
                document.getElementById('attachmentsContainer').innerHTML = '';
                updatePreview();
                
                // 绑定事件
                setupFolderToggle();
            }
        });
        
        // 8. 保存按钮功能
        document.getElementById('saveBtn').addEventListener('click', saveCurrentDocument);
        
        // 9. 预览功能
        function updatePreview() {
            const content = document.getElementById('editor').innerHTML;
            // 转换为Markdown预览
            document.getElementById('previewContent').innerHTML = content;
        }
        
        // 10. 模式切换功能
        function setupModeButtons() {
            const editModeBtn = document.getElementById('editModeBtn');
            const previewModeBtn = document.getElementById('previewModeBtn');
            const splitModeBtn = document.getElementById('splitModeBtn');
            const editorContainer = document.getElementById('editorContainer');
            const previewContainer = document.getElementById('previewContainer');
            
            // 编辑模式
            editModeBtn.addEventListener('click', () => {
                currentMode = 'edit';
                editModeBtn.classList.add('active');
                previewModeBtn.classList.remove('active');
                splitModeBtn.classList.remove('active');
                
                editorContainer.classList.remove('hidden');
                editorContainer.classList.add('flex-1');
                previewContainer.classList.add('hidden');
                previewContainer.classList.remove('flex-1');
            });
            
            // 预览模式
            previewModeBtn.addEventListener('click', () => {
                saveCurrentDocument(false); // 切换前保存但不显示提示
                currentMode = 'preview';
                previewModeBtn.classList.add('active');
                editModeBtn.classList.remove('active');
                splitModeBtn.classList.remove('active');
                
                previewContainer.classList.remove('hidden');
                previewContainer.classList.add('flex-1');
                editorContainer.classList.add('hidden');
                editorContainer.classList.remove('flex-1');
                updatePreview();
            });
            
            // 分屏模式
            splitModeBtn.addEventListener('click', () => {
                saveCurrentDocument(false); // 切换前保存但不显示提示
                currentMode = 'split';
                splitModeBtn.classList.add('active');
                editModeBtn.classList.remove('active');
                previewModeBtn.classList.remove('active');
                
                editorContainer.classList.remove('hidden');
                editorContainer.classList.add('flex-1');
                previewContainer.classList.remove('hidden');
                previewContainer.classList.add('flex-1');
                updatePreview();
            });
            
            // 编辑器内容变化时更新预览
            document.getElementById('editor').addEventListener('input', () => {
                if (currentMode === 'preview' || currentMode === 'split') {
                    updatePreview();
                }
            });
        }
        
        // 11. 附件上传功能
        document.getElementById('addAttachment').addEventListener('click', () => {
            document.getElementById('attachmentInput').click();
        });
        
        document.getElementById('attachmentInput').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileId = `attachment-${attachmentIdCounter++}`;
                    addAttachmentToUI(fileId, file.name, formatFileSize(file.size));
                }
                
                // 保存附件信息
                saveCurrentDocument();
                
                // 重置input，允许重复选择同一文件
                this.value = '';
            }
        });
        
        function addAttachmentToUI(id, name, size) {
            const attachmentsContainer = document.getElementById('attachmentsContainer');
            const attachment = document.createElement('div');
            attachment.className = 'file-attachment';
            attachment.dataset.id = id;
            
            // 确定文件图标
            const fileExtension = name.split('.').pop().toLowerCase();
            let fileIcon = 'fa-file-o';
            
            if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                fileIcon = 'fa-file-image-o';
            } else if (['pdf'].includes(fileExtension)) {
                fileIcon = 'fa-file-pdf-o';
            } else if (['doc', 'docx'].includes(fileExtension)) {
                fileIcon = 'fa-file-word-o';
            } else if (['xls', 'xlsx'].includes(fileExtension)) {
                fileIcon = 'fa-file-excel-o';
            } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                fileIcon = 'fa-file-zip-o';
            } else if (['mp3', 'wav', 'flac'].includes(fileExtension)) {
                fileIcon = 'fa-file-audio-o';
            } else if (['mp4', 'avi', 'mov'].includes(fileExtension)) {
                fileIcon = 'fa-file-video-o';
            }
            
            attachment.innerHTML = `
                <i class="fa ${fileIcon} file-icon"></i>
                <div class="file-info">
                    <div class="file-name">${name}</div>
                    <div class="file-size">${size}</div>
                </div>
                <button class="delete-attachment text-gray-500 dark:text-gray-400 hover:text-red-500 p-2">
                    <i class="fa fa-times"></i>
                </button>
            `;
            
            attachmentsContainer.appendChild(attachment);
            
            // 添加删除附件事件
            attachment.querySelector('.delete-attachment').addEventListener('click', () => {
                attachment.remove();
                saveCurrentDocument();
            });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 12. 绑定文件夹操作按钮
        function bindFolderActionButtons(folder) {
            // 添加子文件夹
            const addChildBtn = folder.querySelector('.add-child-folder');
            if (addChildBtn) {
                addChildBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const folderName = prompt('请输入文件夹名称:');
                    if (folderName) {
                        const subFolderContainer = folder.querySelector('div.pl-6');
                        let subContainer;
                        
                        // 如果没有子容器，创建一个
                        if (!subFolderContainer) {
                            subContainer = document.createElement('div');
                            subContainer.className = 'pl-6 mt-1 space-y-1';
                            folder.appendChild(subContainer);
                        } else {
                            subContainer = subFolderContainer;
                            subContainer.classList.remove('hidden');
                        }
                        
                        // 创建新文件夹
                        const newFolder = document.createElement('div');
                        newFolder.className = 'folder-item';
                        newFolder.id = `folder-${folderIdCounter++}`;
                        newFolder.innerHTML = `
                            <div class="folder-tree-item flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fa fa-folder text-yellow-500 mr-2"></i>
                                    <span class="folder-name">${folderName}</span>
                                </div>
                                <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                                    <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-plus-circle"></i>
                                    </button>
                                    <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                        <i class="fa fa-pencil"></i>
                                    </button>
                                    <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="pl-6 mt-1 space-y-1 hidden">
                                <!-- 子内容将在这里添加 -->
                            </div>
                        `;
                        
                        subContainer.appendChild(newFolder);
                        
                        // 更新文件夹图标为打开状态
                        const folderIcon = folder.querySelector('.fa-folder');
                        if (folderIcon) {
                            folderIcon.classList.replace('fa-folder', 'fa-folder-open');
                        }
                        
                        // 绑定事件
                        setupFolderToggle();
                    }
                });
            }
            
            // 重命名文件夹
            const renameBtn = folder.querySelector('.rename-folder');
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentName = folder.querySelector('.folder-name').textContent;
                    const newName = prompt('请输入新名称:', currentName);
                    if (newName && newName !== currentName) {
                        folder.querySelector('.folder-name').textContent = newName;
                    }
                });
            }
            
            // 删除文件夹
            const deleteBtn = folder.querySelector('.delete-folder');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('确定要删除这个文件夹吗？文件夹内的所有内容也将被删除。')) {
                        folder.remove();
                    }
                });
            }
        }
        
        // 添加根文件夹
        document.getElementById('addRootFolder').addEventListener('click', () => {
            const folderName = prompt('请输入文件夹名称:');
            if (folderName) {
                const folderTree = document.getElementById('folderTree');
                
                // 创建新文件夹
                const newFolder = document.createElement('div');
                newFolder.className = 'folder-item';
                newFolder.id = `folder-${folderIdCounter++}`;
                newFolder.innerHTML = `
                    <div class="folder-tree-item flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-folder text-yellow-500 mr-2"></i>
                            <span class="folder-name">${folderName}</span>
                        </div>
                        <div class="folder-actions opacity-0 hover:opacity-100 transition-opacity">
                            <button class="add-child-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                <i class="fa fa-plus-circle"></i>
                            </button>
                            <button class="rename-folder p-1 text-gray-500 dark:text-gray-400 hover:text-primary">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="delete-folder p-1 text-gray-500 dark:text-gray-400 hover:text-red-500">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pl-6 mt-1 space-y-1 hidden">
                        <!-- 子内容将在这里添加 -->
                    </div>
                `;
                
                folderTree.appendChild(newFolder);
                
                // 绑定事件
                setupFolderToggle();
            }
        });
        
        // 13. 初始化颜色选择器
        function initColorPalettes() {
            // 定义常用颜色
            const colors = [
                '#000000', '#333333', '#666666', '#999999', '#CCCCCC', '#EEEEEE', '#FFFFFF',
                '#FF0000', '#FF9900', '#FFFF00', '#00FF00', '#00FFFF', '#0000FF', '#9900FF', '#FF00FF',
                '#FF6666', '#FFCC99', '#FFFF99', '#CCFF99', '#CCFFFF', '#99CCFF', '#CC99FF', '#FF99CC'
            ];
            
            // 创建文本颜色选择器
            const foreColorPalette = document.querySelector('#foreColorPalette .grid');
            colors.forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.className = 'color-btn';
                colorBtn.style.backgroundColor = color;
                colorBtn.title = color;
                
                // 为深色背景添加边框，使白色可见
                if (color === '#FFFFFF') {
                    colorBtn.classList.add('border', 'border-gray-300');
                }
                
                colorBtn.addEventListener('click', () => {
                    document.execCommand('foreColor', false, color);
                    document.getElementById('editor').focus();
                    
                    // 更新颜色指示器
                    document.querySelector('#foreColor .color-indicator').style.backgroundColor = color;
                    
                    // 关闭颜色面板
                    foreColorPalette.parentElement.classList.add('hidden');
                    
                    // 自动保存
                    saveCurrentDocument();
                    updatePreview();
                });
                
                foreColorPalette.appendChild(colorBtn);
            });
            
            // 创建背景颜色选择器
            const hiliteColorPalette = document.querySelector('#hiliteColorPalette .grid');
            // 额外添加一个透明色作为清除背景色的选项
            [...colors, 'transparent'].forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.className = 'color-btn';
                colorBtn.style.backgroundColor = color;
                colorBtn.title = color;
                
                // 为透明色添加特殊样式
                if (color === 'transparent') {
                    colorBtn.innerHTML = '<i class="fa fa-ban text-gray-500"></i>';
                } else if (color === '#FFFFFF') {
                    colorBtn.classList.add('border', 'border-gray-300');
                }
                
                colorBtn.addEventListener('click', () => {
                    document.execCommand('hiliteColor', false, color);
                    document.getElementById('editor').focus();
                    
                    // 更新颜色指示器
                    const indicator = document.querySelector('#hiliteColor .color-indicator');
                    if (color === 'transparent') {
                        indicator.style.backgroundColor = 'transparent';
                        indicator.style.border = '1px solid #999';
                    } else {
                        indicator.style.backgroundColor = color;
                        indicator.style.border = 'none';
                    }
                    
                    // 关闭颜色面板
                    hiliteColorPalette.parentElement.classList.add('hidden');
                    
                    // 自动保存
                    saveCurrentDocument();
                    updatePreview();
                });
                
                hiliteColorPalette.appendChild(colorBtn);
            });
            
            // 文本颜色按钮点击事件 - 显示/隐藏颜色面板
            const foreColorBtn = document.getElementById('foreColor');
            foreColorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('foreColorPalette').classList.toggle('hidden');
                document.getElementById('hiliteColorPalette').classList.add('hidden');
            });
            
            // 背景颜色按钮点击事件 - 显示/隐藏颜色面板
            const hiliteColorBtn = document.getElementById('hiliteColor');
            hiliteColorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('hiliteColorPalette').classList.toggle('hidden');
                document.getElementById('foreColorPalette').classList.add('hidden');
            });
            
            // 点击页面其他地方关闭颜色面板
            document.addEventListener('click', () => {
                document.getElementById('foreColorPalette').classList.add('hidden');
                document.getElementById('hiliteColorPalette').classList.add('hidden');
            });
            
            // 阻止颜色面板内部点击事件冒泡
            document.getElementById('foreColorPalette').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            document.getElementById('hiliteColorPalette').addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // 设置其他事件监听器
        function setupEventListeners() {
            // 编辑器工具栏按钮事件
            document.querySelectorAll('.editor-toolbar-btn[data-command]').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.getAttribute('data-command');
                    let value = null;
                    
                    if (command === 'createLink') {
                        value = prompt('请输入链接地址:');
                        if (!value) return; // 如果用户取消，则不执行命令
                    } else if (command === 'insertImage') {
                        value = prompt('请输入图片URL:');
                        if (!value) return; // 如果用户取消，则不执行命令
                    }
                    
                    document.execCommand(command, false, value);
                    document.getElementById('editor').focus();
                    
                    // 自动保存
                    saveCurrentDocument();
                    updatePreview();
                });
            });
            
            // 自动保存 - 当编辑器失去焦点时
            document.getElementById('editor').addEventListener('blur', saveCurrentDocument);
            
            // 窗口关闭前保存
            window.addEventListener('beforeunload', saveCurrentDocument);
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            setupFolderToggle();
            init();
        });
    </script>
</body>
</html>
